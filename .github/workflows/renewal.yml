name: Euserv VPS Renewal
on:
  schedule:
    - cron: 0 0 6 2 *
  workflow_dispatch: null
jobs:
  renew-vps:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Cache Virtual Environment
        id: cache-venv
        uses: actions/cache@v4
        with:
          path: venv
          key: ${{ runner.os }}-venv-${{ hashFiles('requirements.txt') }}
      - name: Create venv and Install dependencies
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: |
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Run renewal script with retry
        id: renewal
        env:
          EUSERV_USERNAME: ${{ secrets.EUSERV_USERNAME }}
          EUSERV_PASSWORD: ${{ secrets.EUSERV_PASSWORD }}
          EUSERV_2FA: ${{ secrets.EUSERV_2FA }}
          CAPTCHA_USERID: ${{ secrets.CAPTCHA_USERID }}
          CAPTCHA_APIKEY: ${{ secrets.CAPTCHA_APIKEY }}
          EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
        run: |
          source venv/bin/activate

          MAX_RETRIES=3
          RETRY_DELAY=1800  # 30åˆ†é’Ÿ (ç§’)

          for i in $(seq 1 $MAX_RETRIES); do
            echo "========================================="
            echo "ğŸ”„ å°è¯• $i/$MAX_RETRIES - $(date)"
            echo "========================================="
            
            set +e  # å…è®¸éé›¶é€€å‡ºç 
            python Euserv_Renewal.py
            EXIT_CODE=$?
            set -e
            
            # é€€å‡ºç å¤„ç†
            case $EXIT_CODE in
              0)
                echo "âœ… ç»­çº¦æˆåŠŸæˆ–æ— éœ€ç»­çº¦"
                exit 0
                ;;
              2)
                echo "â­ï¸ æœªåˆ°ç»­çº¦æ—¥æœŸï¼Œè·³è¿‡æ‰§è¡Œ (åŠ¨æ€è°ƒåº¦å°†æ›´æ–° cron)"
                # æ­£å¸¸é€€å‡ºï¼Œè®©åç»­æ­¥éª¤æ‰§è¡ŒåŠ¨æ€è°ƒåº¦æ›´æ–°
                exit 0
                ;;
              *)
                echo "âŒ ç»­çº¦å¤±è´¥ (é€€å‡ºç : $EXIT_CODE)"
                if [ $i -lt $MAX_RETRIES ]; then
                  echo "â³ ç­‰å¾… 30 åˆ†é’Ÿåé‡è¯•..."
                  sleep $RETRY_DELAY
                fi
                ;;
            esac
          done

          echo "ğŸ’¥ æ‰€æœ‰ $MAX_RETRIES æ¬¡é‡è¯•å‡å¤±è´¥"
          exit 1
      - name: Update schedule for next renewal
        if: steps.renewal.outputs.next_cron != ''
        uses: gr2m/set-cron-schedule-action@v2
        with:
          token: ${{ secrets.PAT_WITH_WORKFLOW_SCOPE }}
          cron: ${{ steps.renewal.outputs.next_cron }}
          workflow: renewal.yml
          message: "ci(renewal): æ›´æ–°ä¸‹æ¬¡ç»­çº¦æ—¶é—´ä¸º ${{ steps.renewal.outputs.next_date }}"
      - name: Upload failed captcha for debugging
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: captcha-failed
          path: captcha_failed.png
          if-no-files-found: ignore
          retention-days: 7
